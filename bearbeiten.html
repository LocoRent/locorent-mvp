<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Inserat bearbeiten – Locorent</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background: #f1f8e9;
      margin: 0;
      padding: 0;
      color: #1b5e20;
    }

    header {
      background-color: #2e7d32;
      color: white;
      padding: 1rem 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    nav a {
      color: white;
      margin-left: 1rem;
      text-decoration: none;
      font-weight: 600;
    }

    main {
      max-width: 700px;
      margin: 2rem auto;
      background: white;
      padding: 2rem;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    h2 { margin-bottom: 1rem; }

    label {
      display: block;
      margin-top: 1rem;
      font-weight: 600;
    }

    input, textarea, select {
      width: 100%;
      padding: 0.7rem;
      border: 1px solid #ccc;
      border-radius: 8px;
      margin-top: 0.3rem;
    }

    .dropzone {
      border: 2px dashed #2e7d32;
      padding: 1rem;
      border-radius: 10px;
      text-align: center;
      cursor: pointer;
      margin-top: 1rem;
      background-color: #f9fff4;
    }

    .dropzone:hover {
      background-color: #e6f4ea;
    }

    #preview {
      margin-top: 1rem;
      max-width: 100%;
      max-height: 200px;
      border-radius: 10px;
    }

    button {
      margin-top: 2rem;
      padding: 0.8rem 1.6rem;
      background-color: #2e7d32;
      color: white;
      border: none;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
    }

    button:hover {
      background-color: #1b5e20;
    }
  </style>
</head>
<body>
  <header>
    <h1>Inserat bearbeiten</h1>
    <nav>
      <a href="inserate.html">Meine Inserate</a>
    </nav>
  </header>

  <main>
    <h2>Inserat bearbeiten</h2>

    <label for="title">Titel</label>
    <input type="text" id="title" />

    <label for="category">Kategorie</label>
    <input type="text" id="category" />

    <label for="price">Preis pro Tag (€)</label>
    <input type="number" id="price" />

    <label for="description">Beschreibung</label>
    <textarea id="description" rows="3"></textarea>

    <label>Bild hochladen</label>
    <div id="dropzone" class="dropzone">
      Klicke oder ziehe ein Bild hierher
    </div>
    <img id="preview" src="" alt="Bildvorschau" style="display: none;" />

    <button onclick="saveChanges()">Speichern</button>
  </main>

  <script>
    const supabase = window.supabase.createClient(
      'https://flnjalgqtkqycsaymmbd.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZsbmphbGdxdGtxeWNzYXltbWJkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg4NTkwOTAsImV4cCI6MjA2NDQzNTA5MH0.pPDeWCrjDrOGeHVJy5YmMQFYUGl7nvAyx3uxhQYNH_Q'
    );

    const params = new URLSearchParams(window.location.search);
    const listingId = params.get("id");
    let uploadedImageUrl = "";

    async function loadListing() {
      const { data, error } = await supabase.from('listings').select('*').eq('id', listingId).single();
      if (error || !data) return alert("Fehler beim Laden des Inserats");

      document.getElementById("title").value = data.title;
      document.getElementById("category").value = data.category;
      document.getElementById("price").value = data.price_per_day;
      document.getElementById("description").value = data.description;
      if (data.image_url) {
        document.getElementById("preview").src = data.image_url;
        document.getElementById("preview").style.display = 'block';
        uploadedImageUrl = data.image_url;
      }
    }

    async function saveChanges() {
      const title = document.getElementById("title").value;
      const category = document.getElementById("category").value;
      const price = parseFloat(document.getElementById("price").value);
      const description = document.getElementById("description").value;

      const { error } = await supabase.from("listings").update({
        title,
        category,
        price_per_day: price,
        description,
        image_url: uploadedImageUrl
      }).eq("id", listingId);

      if (error) {
        alert("Fehler beim Speichern");
      } else {
        alert("Gespeichert!");
        window.location.href = "inserate.html";
      }
    }

    const dropzone = document.getElementById("dropzone");
    dropzone.addEventListener("click", () => {
      const input = document.createElement("input");
      input.type = "file";
      input.accept = "image/*";
      input.onchange = () => handleFile(input.files[0]);
      input.click();
    });

    dropzone.addEventListener("dragover", (e) => {
      e.preventDefault();
      dropzone.style.backgroundColor = "#e0f2f1";
    });

    dropzone.addEventListener("dragleave", () => {
      dropzone.style.backgroundColor = "";
    });

    dropzone.addEventListener("drop", (e) => {
      e.preventDefault();
      dropzone.style.backgroundColor = "";
      const file = e.dataTransfer.files[0];
      handleFile(file);
    });

    async function handleFile(file) {
      if (!file) return;

      const filename = `${Date.now()}_${file.name}`;
      const { data, error } = await supabase.storage
        .from('inserate')
        .upload(filename, file, {
          cacheControl: '3600',
          upsert: false
        });

      if (error) {
        alert("Fehler beim Hochladen");
        return;
      }

      const { data: urlData } = await supabase
        .storage
        .from('inserate')
        .getPublicUrl(data.path);

      uploadedImageUrl = urlData.publicUrl;

      const preview = document.getElementById("preview");
      preview.src = uploadedImageUrl;
      preview.style.display = "block";
    }

    loadListing();
  </script>
</body>
</html>
