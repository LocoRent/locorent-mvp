<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Locorent – Nachhaltig mieten in Deutschland</title>
  <meta name="description" content="Finde und vermiete nachhaltige Mietobjekte in deiner Nähe bei Locorent." />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <div id="layout-container"></div>

  <section class="hero" aria-label="Suchbereich">
    <h2>Finde das perfekte Mietobjekt</h2>
    <form class="search-form" onsubmit="event.preventDefault(); search();" role="search" aria-label="Suchformular">
      <input type="text" placeholder="Was suchst du?" id="search-input" aria-label="Suchbegriff eingeben" />
      <select id="category-select" aria-label="Kategorie auswählen">
        <option value="">Alle Kategorien</option>
        <option value="fahrzeuge">Fahrzeuge</option>
        <option value="transporter">Transporter</option>
        <option value="boote">Boote</option>
        <option value="fahrrad">Fahrräder & E-Bikes</option>
        <option value="werkzeuge">Werkzeuge</option>
        <option value="maschinen">Maschinen & Baugeräte</option>
        <option value="party">Party & Event</option>
        <option value="technik">Technik</option>
        <option value="haushalt">Haushalt & Möbel</option>
        <option value="garten">Garten</option>
        <option value="freizeit">Freizeit & Sport</option>
        <option value="baby">Baby & Kind</option>
      </select>
      <div style="position: relative; flex: 1; min-width: 200px;">
        <input type="text" placeholder="Ort" id="location-input" autocomplete="off" aria-label="Ort eingeben" />
        <div id="suggestions" role="listbox" aria-label="Ortsvorschläge"></div>
      </div>
      <select id="radius-select" aria-label="Suchradius auswählen">
        <option value="">Ganzer Ort</option>
        <option value="5">5 km</option>
        <option value="10">10 km</option>
        <option value="20">20 km</option>
        <option value="30">30 km</option>
        <option value="50">50 km</option>
        <option value="100">100 km</option>
        <option value="200">200 km</option>
      </select>
      <button type="submit">Suchen</button>
    </form>
  </section>

  <section aria-label="Neueste Angebote">
    <h2>Neueste Angebote</h2>
    <div id="newest-offers" class="category-grid" aria-live="polite" aria-busy="true"><p>⏳ Lade Angebote…</p></div>
    <div class="more-link">
      <a href="angebote_neueste.html" class="btn-more">MEHR <span>→</span></a>
    </div>
  </section>

  <section aria-label="Beliebte Angebote">
    <h2>Beliebte Angebote</h2>
    <div id="popular-offers" class="category-grid" aria-live="polite" aria-busy="true"><p>⏳ Lade Angebote…</p></div>
    <div class="more-link">
      <a href="angebote_beliebte.html" class="btn-more">MEHR <span>→</span></a>
    </div>
  </section>

  <script>
    fetch('components/layout.html')
      .then(res => res.text())
      .then(html => {
        document.getElementById('layout-container').innerHTML = html;
      });

    const supabase = window.supabase.createClient(
      'https://flnjalgqtkqycsaymmbd.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZsbmphbGdxdGtxeWNzYXltbWJkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg4NTkwOTAsImV4cCI6MjA2NDQzNTA5MH0.pPDeWCrjDrOGeHVJy5YmMQFYUGl7nvAyx3uxhQYNH_Q'
    );

    let userSession = null;
    let selectedAddressData = null;

    async function init() {
      const { data: { session } } = await supabase.auth.getSession();
      userSession = session;
      await loadNewestOffers();
      await loadPopularOffers();
    }

    async function loadNewestOffers() {
      const container = document.getElementById('newest-offers');
      container.setAttribute('aria-busy', 'true');
      container.innerHTML = '<p>⏳ Lade Angebote…</p>';
      const { data, error } = await supabase
        .from('listings')
        .select('*')
        .order('created_at', { ascending: false })
        .limit(5);
      if (error || !data.length) {
        container.innerHTML = '<p>Keine Angebote gefunden.</p>';
        return;
      }
      container.removeAttribute('aria-busy');
      await renderOffers(data, 'newest-offers');
    }

    async function loadPopularOffers() {
      const container = document.getElementById('popular-offers');
      container.setAttribute('aria-busy', 'true');
      container.innerHTML = '<p>⏳ Lade Angebote…</p>';
      const { data, error } = await supabase
        .from('listings')
        .select('*')
        .order('views', { ascending: false })
        .limit(5);
      if (error || !data.length) {
        container.innerHTML = '<p>Keine Angebote gefunden.</p>';
        return;
      }
      container.removeAttribute('aria-busy');
      await renderOffers(data, 'popular-offers');
    }

    async function renderOffers(items, containerId) {
      const container = document.getElementById(containerId);
      container.innerHTML = '';
      for (const item of items) {
        const card = document.createElement('div');
        card.className = 'result-card';
        const isFav = userSession?.user ? await checkIfFavorite(item.id) : false;
        card.innerHTML = `
          <img src="${item.image_urls?.[0] || 'https://via.placeholder.com/400x200'}" alt="${item.title}" />
          <h3>${item.title}</h3>
          <p><strong>Kategorie:</strong> ${item.category || 'Unbekannt'}</p>
          <p><strong>Preis pro Tag:</strong> ${item.price_per_day || 'k. A.'} €</p>
          <button onclick="window.location.href='mietobjekt.html?id=${item.id}'">Details ansehen</button>
          <button class="fav-btn">${isFav ? 'Favorit entfernen' : 'Zu Favoriten'}</button>
        `;
        const favBtn = card.querySelector('.fav-btn');
        if (userSession?.user) {
          favBtn.onclick = async (e) => {
            e.preventDefault();
            const nowFav = await toggleFavorite(item.id);
            favBtn.innerText = nowFav ? 'Favorit entfernen' : 'Zu Favoriten';
          };
        } else {
          favBtn.disabled = true;
          favBtn.innerText = "Login erforderlich";
        }
        container.appendChild(card);
      }
    }

    async function checkIfFavorite(listingId) {
      if (!userSession?.user) return false;
      const { data } = await supabase
        .from('favorites')
        .select('*')
        .eq('user_id', userSession.user.id)
        .eq('listing_id', listingId)
        .maybeSingle();
      return !!data;
    }

    async function toggleFavorite(listingId) {
      if (!userSession?.user) return false;
      const { data } = await supabase
        .from('favorites')
        .select('*')
        .eq('user_id', userSession.user.id)
        .eq('listing_id', listingId)
        .maybeSingle();
      if (data) {
        await supabase.from('favorites').delete().eq('id', data.id);
        return false;
      } else {
        await supabase.from('favorites').insert({ user_id: userSession.user.id, listing_id: listingId });
        return true;
      }
    }

    document.getElementById('location-input').addEventListener('input', async (e) => {
      const value = e.target.value.trim();
      const suggestionsBox = document.getElementById('suggestions');
      if (value.length < 2) return suggestionsBox.innerHTML = '';
      try {
        const res = await fetch(`https://corsproxy.io/?https://nominatim.openstreetmap.org/search?format=json&accept-language=de&countrycodes=de&addressdetails=1&limit=6&q=${encodeURIComponent(value)}`);
        const results = await res.json();
        suggestionsBox.innerHTML = '';
        results.forEach(r => {
          const ort = r.address.city || r.address.town || r.address.village || r.display_name.split(',')[0];
          const bundesland = r.address.state || '';
          const display = [ort, bundesland].filter(Boolean).join(', ');
          const div = document.createElement('div');
          div.textContent = display;
          div.setAttribute('role', 'option');
          div.tabIndex = 0;
          div.onclick = () => {
            document.getElementById('location-input').value = display;
            selectedAddressData = {
              city: ort,
              lat: parseFloat(r.lat),
              lon: parseFloat(r.lon),
              location: display
            };
            suggestionsBox.innerHTML = '';
          };
          div.onkeydown = (evt) => {
            if(evt.key === 'Enter' || evt.key === ' ') {
              evt.preventDefault();
              div.click();
            }
          };
          suggestionsBox.appendChild(div);
        });
      } catch(err) {
        console.error("Fehler bei Ortssuche:", err);
      }
    });

    function search() {
      const keyword = document.getElementById("search-input").value.trim();
      const category = document.getElementById("category-select").value.trim();
      const location = document.getElementById("location-input").value.trim();
      const radius = document.getElementById("radius-select").value.trim();
      const params = new URLSearchParams({ keyword, category, location, radius });
      window.location.href = `search_results.html?${params.toString()}`;
    }

    init();
  </script>
</body>
</html>
