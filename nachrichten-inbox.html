<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Nachrichteneingang – Locorent</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;500;700&display=swap" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
:root {
  --primary: #2e7d32;
  --white: #fff;
  --text-dark: #0f2e13;
  --radius: 18px;
  --font-primary: 'Poppins', sans-serif;
}

*, *::before, *::after { box-sizing: border-box; }

body {
  margin:0;
  font-family: var(--font-primary);
  background: #f1f8e9;
  color: var(--text-dark);
  display:flex;
  flex-direction:column;
  min-height:100vh;
}

header {
  background-color: var(--primary);
  color: var(--white);
  padding:1.5rem 2rem;
  display:flex;
  justify-content:space-between;
  align-items:center;
  position:sticky;
  top:0;
  z-index:1000;
}

header h1 { font-size:1.8rem; cursor:pointer; margin:0; }

#nav-toggle { display:none; background:none; border:none; font-size:1.8rem; color:white; cursor:pointer; }

nav#main-nav { display:flex; flex-wrap:wrap; gap:1rem; }

nav#main-nav a {
  color:white;
  text-decoration:none;
  font-weight:600;
  position:relative;
}
nav#main-nav a::after {
  content:'';
  position:absolute;
  left:0;
  bottom:-4px;
  width:0;
  height:2px;
  background-color:#b9f6ca;
  transition:width 0.3s;
}
nav#main-nav a:hover::after, nav#main-nav a:focus::after { width:100%; }
nav#main-nav a:hover, nav#main-nav a:focus { color:#b9f6ca; outline:none; }

main {
  max-width:1200px;
  margin:2rem auto 4rem;
  padding:1rem;
  flex-grow:1;
}

h2 { font-size:2rem; margin-bottom:1.5rem; color:var(--primary); }

#inbox {
  display:grid;
  grid-template-columns: repeat(6, 1fr);
  gap:2rem;
  margin-bottom:2.5rem;
  padding:0 1rem;
}

.chat-card {
  background:white;
  padding:1.5rem;
  border-radius:var(--radius);
  box-shadow:0 12px 30px rgba(46,125,50,0.1);
  cursor:pointer;
  display:flex;
  flex-direction:column;
  position:relative;
  min-height:220px;
  transition:transform 0.3s, box-shadow 0.3s;
}
.chat-card:hover { transform:translateY(-6px); box-shadow:0 20px 48px rgba(46,125,50,0.2); }

.chat-avatar {
  width:70px; height:70px;
  border-radius:50%;
  background:#dcedc8;
  display:flex; justify-content:center; align-items:center;
  font-size:2rem; font-weight:700; color:#1b5e20;
  margin-bottom:0.8rem;
  overflow:hidden;
}
.chat-avatar img { width:100%; height:100%; object-fit:cover; border-radius:50%; }

.chat-info { flex:1; display:flex; flex-direction:column; gap:0.3rem; }

.chat-name { font-weight:700; font-size:1.2rem; color:#1b5e20; }
.chat-preview { font-size:1rem; color:#555; font-style:italic; margin-bottom:0.5rem; }
.chat-time { font-size:0.8rem; color:#7a7a7a; text-align:right; }

.delete-chat {
  position:absolute; top:12px; right:12px;
  color:#d32f2f; font-size:1.6rem; cursor:pointer;
  transition: transform 0.25s, color 0.25s;
}
.delete-chat:hover { transform:scale(1.3); color:#b71c1c; }

footer {
  width:100%;
  box-sizing:border-box;
  padding:2rem 2rem 1rem;
  background-color:var(--primary);
  color:white;
  text-align:center;
  margin-top:2rem;
  border-radius:var(--radius);
}
footer > div { max-width:1200px; margin:0 auto; display:flex; flex-wrap:wrap; justify-content:space-between; gap:2rem; text-align:left; }
footer > div > div { flex:1; min-width:200px; }
footer h4 { margin-bottom:0.5rem; font-weight:700; font-size:1.1rem; }
footer ul { list-style:none; padding:0; line-height:1.8; }
footer ul li a { color:white; text-decoration:underline; }
footer ul li a:hover { color:#66bb6a; }
footer small { display:block; margin-top:2rem; text-align:center; opacity:0.85; }

@media(max-width:720px){
  #nav-toggle { display:block; }
  nav#main-nav { width:100%; flex-direction:column; display:none; margin-top:1rem; }
  nav#main-nav.show { display:flex; }
  nav#main-nav a { margin:0.4rem 0; padding:0.5rem 1rem; background-color: rgba(255,255,255,0.1); border-radius:6px; }
  #inbox { grid-template-columns:repeat(2,1fr); gap:1rem; padding:0 0.5rem; }
  footer > div { flex-direction:column; align-items:flex-start; }
  footer > div > div { width:100%; }
}
</style>
</head>
<body>

<header>
  <h1 tabindex="0" onclick="location.href='index.html'">Locorent</h1>
  <button id="nav-toggle" aria-label="Menü öffnen" aria-expanded="false" aria-controls="main-nav">☰</button>
  <nav id="main-nav">
    <a href="index.html">Start</a>
    <a href="profil.html">Mein Profil</a>
    <a href="nachrichten-inbox.html">📨 Nachrichten</a>
    <a href="favoriten.html">Meine Favoriten</a>
    <a href="inserate.html">Meine Inserate</a>
    <a href="#" onclick="logout(event)">Logout</a>
  </nav>
</header>

<main>
  <h2>📨 Nachrichteneingang</h2>
  <div id="inbox" aria-live="polite" aria-relevant="additions">Lade Nachrichten...</div>
</main>

<footer>
<div>
<div>
<h4>Mieten & Vermieten</h4>
<ul>
<li><a href="so-funktionierts.html">So funktioniert's</a></li>
<li><a href="vermieter-werden.html">Werde zum Vermieter</a></li>
<li><a href="kategorien.html">Beliebte Kategorien</a></li>
<li><a href="vermieter-tipps.html">Tipps & Tricks für Vermieter</a></li>
<li><a href="hilfe-faq.html">Hilfe und FAQ</a></li>
</ul>
</div>
<div>
<h4>Wissenswertes</h4>
<ul>
<li><a href="agb.html">AGB & Impressum</a></li>
<li><a href="datenschutz.html">Datenschutz</a></li>
</ul>
</div>
<div>
<h4>Über uns</h4>
<ul>
<li><a href="kontakt.html">Kontaktieren Sie uns</a></li>
<li><a href="social-media.html">Folgen Sie uns</a></li>
<li><a href="mission.html">Unsere Mission</a></li>
</ul>
</div>
</div>
<small>© 2025 Locorent – Mieten statt kaufen. Gemeinsam nachhaltig.</small>
</footer>

<script>
const supabase = window.supabase.createClient(
  'https://flnjalgqtkqycsaymmbd.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZsbmphbGdxdGtxeWNzYXltbWJkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg4NTkwOTAsImV4cCI6MjA2NDQzNTA5MH0.pPDeWCrjDrOGeHVJy5YmMQFYUGl7nvAyx3uxhQYNH_Q'
);

let currentPage = 1;
const pageSize = 24;

document.getElementById('nav-toggle').addEventListener('click',()=>{
  const nav = document.getElementById('main-nav');
  nav.classList.toggle('show');
  document.getElementById('nav-toggle').setAttribute('aria-expanded', nav.classList.contains('show'));
});

async function logout(event){event.preventDefault(); await supabase.auth.signOut(); window.location.href="login.html";}

function timeAgo(dateString){
  const date=new Date(dateString);
  const diff=(Date.now()-date.getTime())/1000;
  if(diff<60)return"gerade eben";
  if(diff<3600)return`${Math.floor(diff/60)} Min.`;
  if(diff<86400)return`${Math.floor(diff/3600)} Std.`;
  return`${Math.floor(diff/86400)} Tg.`;
}

async function loadInbox(page=1){
  const {data:{user}} = await supabase.auth.getUser();
  if(!user) return window.location.href="login.html";

  const {data:messages} = await supabase.from('messages')
    .select('*')
    .or(`sender_id.eq.${user.id},receiver_id.eq.${user.id}`)
    .order('created_at',{ascending:false});

  const inbox = document.getElementById('inbox');
  inbox.innerHTML='';

  if(!messages || messages.length===0){ inbox.innerHTML="<p>Keine Nachrichten gefunden.</p>"; return; }

  const uniqueChats = new Map();
  messages.forEach(msg=>{
    const otherId = msg.sender_id===user.id ? msg.receiver_id : msg.sender_id;
    const key = `${msg.listing_id}_${otherId}`;
    if(!uniqueChats.has(key)) uniqueChats.set(key,msg);
  });

  const chatArray = Array.from(uniqueChats.values());
  const totalCount = chatArray.length;
  const from=(page-1)*pageSize;
  const to=from+pageSize;
  const pagedChats=chatArray.slice(from,to);

  for(const msg of pagedChats){
    const otherId = msg.sender_id===user.id ? msg.receiver_id : msg.sender_id;
    const [{data:userData}] = await Promise.all([
      supabase.from('profiles').select('name, avatar_url').eq('id',otherId).single()
    ]);
    const name = userData?.name || 'Unbekannt';
    const avatar = userData?.avatar_url || null;

    const card=document.createElement('div');
    card.className='chat-card';
    card.tabIndex=0;
    card.onclick=()=>window.location.href=`nachrichten.html?listing_id=${msg.listing_id}&with=${otherId}`;
    card.innerHTML=`
      <div class="delete-chat" title="Chat löschen" tabindex="0" role="button" aria-label="Chat löschen" onclick="event.stopPropagation(); confirmDelete('${msg.listing_id}','${otherId}',this)">🗑️</div>
      <div class="chat-avatar">${avatar?`<img src="${avatar}" alt="${name}" />`:`<span>${name.charAt(0).toUpperCase()}</span>`}</div>
      <div class="chat-info">
        <div class="chat-name">${name}</div>
        <div class="chat-preview">💬 ${msg.content.slice(0,90)}${msg.content.length>90?'…':''}</div>
        <div class="chat-time">⏱️ ${timeAgo(msg.created_at)}</div>
      </div>
    `;
    inbox.appendChild(card);
  }

  // Pagination
  const pagination = document.createElement('div');
  pagination.style.cssText="grid-column:1/-1; display:flex; justify-content:center; gap:10px; margin-top:20px;";
  const totalPages = Math.ceil(totalCount/pageSize);
  if(page>1){ const prevBtn=document.createElement('button'); prevBtn.textContent="← Zurück"; prevBtn.onclick=()=>{currentPage--; loadInbox(currentPage);}; pagination.appendChild(prevBtn); }
  pagination.appendChild(document.createTextNode(`Seite ${page} von ${totalPages}`));
  if(page<totalPages){ const nextBtn=document.createElement('button'); nextBtn.textContent="Weiter →"; nextBtn.onclick=()=>{currentPage++; loadInbox(currentPage);}; pagination.appendChild(nextBtn); }
  inbox.appendChild(pagination);
}

async function confirmDelete(listingId,otherId,el){
  if(!confirm("Möchtest du diesen Chatverlauf wirklich löschen?")) return;
  const {data:{user}} = await supabase.auth.getUser();
  const {error} = await supabase.from('messages')
    .delete()
    .or(`and(sender_id.eq.${user.id},receiver_id.eq.${otherId},listing_id.eq.${listingId}),and(receiver_id.eq.${user.id},sender_id.eq.${otherId},listing_id.eq.${listingId})`);
  if(!error) el.closest('.chat-card').remove();
  else alert("Fehler beim Löschen des Chats.");
}

loadInbox();
</script>

</body>
</html>
