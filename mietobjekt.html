<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mietobjekt – Locorent</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background: #f1f8e9;
      margin: 0;
      padding: 0;
      color: #1b5e20;
    }
    header {
      background-color: #2e7d32;
      color: white;
      padding: 1rem 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    nav a {
      color: white;
      margin-left: 1rem;
      text-decoration: none;
      font-weight: 600;
    }
    main {
      max-width: 1000px;
      margin: 2rem auto;
      padding: 1rem;
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    .container {
      display: flex;
      gap: 2rem;
      flex-wrap: wrap;
    }
    .left {
      flex: 2;
      min-width: 300px;
    }
    .right {
      flex: 1;
      min-width: 250px;
      background: #f9f9f9;
      padding: 1rem;
      border-radius: 8px;
    }
    .main-image {
      width: 100%;
      height: 300px;
      object-fit: cover;
      border-radius: 8px;
      margin-bottom: 0.5rem;
    }
    .thumbnail-bar {
      display: flex;
      gap: 0.5rem;
      overflow-x: auto;
      margin-bottom: 1rem;
    }
    .thumbnail-bar img {
      height: 70px;
      width: 100px;
      object-fit: cover;
      border-radius: 6px;
      cursor: pointer;
      border: 2px solid transparent;
    }
    .thumbnail-bar img.active {
      border-color: #2e7d32;
    }
    .calendar, .booking-form {
      margin-top: 2rem;
      padding: 1rem;
      border: 1px solid #ccc;
      border-radius: 8px;
      background: #f9fff4;
    }
    input[type="text"] {
      width: 100%;
      padding: 0.5rem;
      border-radius: 6px;
      border: 1px solid #ccc;
      margin: 0.5rem 0;
    }
    button {
      margin-top: 0.5rem;
      padding: 0.7rem 1.5rem;
      background-color: #2e7d32;
      color: white;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
    }
    button:hover {
      background-color: #1b5e20;
    }
    .chat-link {
      margin-top: 1rem;
    }
    .vermieter-box h3 {
      margin-top: 0;
    }
    .vermieter-box p {
      margin: 0.4rem 0;
    }
  </style>
</head>
<body>
<header>
  <h1>Locorent</h1>
  <nav>
    <a href="index.html">Start</a>
    <a href="profil.html">Profil</a>
  </nav>
</header>

<main>
  <div id="listing-details">Lade Daten...</div>
</main>

<script>
  const supabase = window.supabase.createClient(
    'https://flnjalgqtkqycsaymmbd.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZsbmphbGdxdGtxeWNzYXltbWJkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg4NTkwOTAsImV4cCI6MjA2NDQzNTA5MH0.pPDeWCrjDrOGeHVJy5YmMQFYUGl7nvAyx3uxhQYNH_Q'
  );

  const params = new URLSearchParams(window.location.search);
  const listingId = params.get('id');
  let currentUser = null;
  let listingOwnerId = null;
  let unavailableRanges = [];

  async function loadListing() {
    const { data: { user } } = await supabase.auth.getUser();
    if (!user) {
      alert("Bitte einloggen.");
      return;
    }
    currentUser = user;

    const { data: listing, error } = await supabase
      .from('listings')
      .select('*')
      .eq('id', listingId)
      .single();

    const container = document.getElementById('listing-details');
    if (error || !listing) {
      container.innerHTML = '<p>Fehler beim Laden des Inserats.</p>';
      return;
    }

    listingOwnerId = listing.user_id;
    await loadUnavailableDates();

    const imageUrls = listing.image_urls || [];
    const mainImage = imageUrls[0] || 'https://via.placeholder.com/800x300?text=Kein+Bild';
    const thumbnails = imageUrls.map((url, idx) =>
      `<img src="${url}" class="${idx === 0 ? 'active' : ''}" onclick="switchImage(this)">`
    ).join('');  

    await loadVermieterInfo(listingOwnerId);

    container.innerHTML = `
      <div class="container">
        <div class="left">
          <h2>${listing.title}</h2>
          <img src="${mainImage}" alt="Hauptbild" class="main-image" id="mainImage">
          ${imageUrls.length > 1 ? `<div class="thumbnail-bar">${thumbnails}</div>` : ''}
          <p><strong>Kategorie:</strong> ${listing.category}</p>
          <p><strong>Preis pro Tag:</strong> ${listing.price_per_day} €</p>
          <p><strong>Beschreibung:</strong><br>${listing.description}</p>

          <div class="chat-link">
            <button onclick="goToChat()">Nachricht an Vermieter senden</button>
          </div>

          <div class="calendar">
            <label><strong>Verfügbarkeit:</strong></label><br>
            <input type="text" id="date-range" readonly />
          </div>

          <div class="booking-form">
            <button onclick="requestBooking()">Mietanfrage senden</button>
          </div>
        </div>
        <div class="right">
          <div class="vermieter-box">
            <h3>Vermieter</h3>
            <p><strong>Name:</strong> <span id="vermieter-name">Lade Name...</span></p>
            <p><strong>Wohnort:</strong> <span id="vermieter-city">Lade Wohnort...</span></p>
            <div class="chat-link">
              <button onclick="goToChat()">Nachricht an Vermieter senden</button>
            </div>
          </div>
        </div>
      </div>
    `;

    setupFlatpickr();
  }

  function switchImage(imgElement) {
    const newSrc = imgElement.getAttribute("src");
    document.getElementById("mainImage").setAttribute("src", newSrc);
    document.querySelectorAll(".thumbnail-bar img").forEach(img => img.classList.remove("active"));
    imgElement.classList.add("active");
  }

  async function loadVermieterInfo(userId) {
    // Benutzerdaten des aktuell angemeldeten Benutzers holen
    const { data: user, error } = await supabase.auth.getUser();

    if (error || !user) {
      console.error("Fehler beim Laden der Vermieterinformationen:", error);
      document.getElementById('vermieter-name').textContent = 'Unbekannt';
      document.getElementById('vermieter-city').textContent = 'Unbekannt';
      return;
    }

    // Hier wird die E-Mail des aktuell angemeldeten Benutzers (Vermieter) gesetzt
    document.getElementById('vermieter-name').textContent = user.email || 'Unbekannt';
  }

  async function loadUnavailableDates() {
    const { data, error } = await supabase
      .from('rentals')
      .select('start_date, end_date')
      .eq('listing_id', listingId);

    if (!error && data) {
      unavailableRanges = data.map(r => ({
        from: r.start_date,
        to: r.end_date
      }));
    }
  }

  function setupFlatpickr() {
    flatpickr("#date-range", {
      mode: "range",
      minDate: "today",
      dateFormat: "Y-m-d",
      disable: unavailableRanges
    });
  }

  async function requestBooking() {
    const input = document.getElementById('date-range').value;
    const dates = input.split(" to ");
    if (dates.length !== 2) return alert("Bitte Zeitraum auswählen.");

    const [start, end] = dates;

    const { error } = await supabase.from('rentals').insert({
      user_id: currentUser.id,
      listing_id: listingId,
      start_date: start,
      end_date: end,
      status: "offen",
      title: "Mietanfrage"
    });

    if (error) {
      alert("Fehler: " + error.message);
    } else {
      alert("Anfrage gesendet!");
      document.getElementById("date-range").value = "";
      await loadUnavailableDates();
      setupFlatpickr();
    }
  }

  function goToChat() {
    if (!currentUser || !listingOwnerId) return;
    if (currentUser.id === listingOwnerId) {
      alert("Du kannst dir selbst keine Nachricht schicken.");
      return;
    }
    window.location.href = `nachrichten.html?listing_id=${listingId}&with=${listingOwnerId}`;
  }

  loadListing();
</script>
</body>
</html>
