<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mietobjekt – Locorent</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    /* CSS bleibt unverändert */
  </style>
</head>
<body>
<header>
  <h1>Locorent</h1>
  <nav>
    <a href="index.html">Start</a>
    <a href="profil.html">Profil</a>
  </nav>
</header>

<main>
  <div id="listing-details">Lade Daten...</div>
</main>

<script>
  const supabase = window.supabase.createClient(
    'https://flnjalgqtkqycsaymmbd.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZsbmphbGdxdGtxeWNzYXltbWJkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg4NTkwOTAsImV4cCI6MjA2NDQzNTA5MH0.pPDeWCrjDrOGeHVJy5YmMQFYUGl7nvAyx3uxhQYNH_Q'
  );

  const params = new URLSearchParams(window.location.search);
  const listingId = params.get('id');
  let currentUser = null;
  let listingOwnerId = null;
  let unavailableRanges = [];

  async function loadListing() {
    const { data: { user } } = await supabase.auth.getUser();
    if (!user) {
      alert("Bitte einloggen.");
      window.location.href = "login.html";
      return;
    }
    currentUser = user;

    const { data: listing, error } = await supabase
      .from('listings')
      .select('*')
      .eq('id', listingId)
      .single();

    const container = document.getElementById('listing-details');
    if (error || !listing) {
      container.innerHTML = '<p>Fehler beim Laden des Inserats.</p>';
      return;
    }

    listingOwnerId = listing.user_id;
    await loadUnavailableDates();

    const imageUrls = listing.image_urls || [];
    const mainImage = imageUrls[0] || 'https://via.placeholder.com/800x300?text=Kein+Bild';
    const thumbnails = imageUrls.map((url, idx) =>
      `<img src="${url}" class="${idx === 0 ? 'active' : ''}" onclick="switchImage(this)">`
    ).join('');

    const vermieterHTML = await loadVermieterInfo(listingOwnerId);

    container.innerHTML = `
      <div class="container">
        <div class="left">
          <h2>${listing.title}</h2>
          <img src="${mainImage}" alt="Hauptbild" class="main-image" id="mainImage">
          ${imageUrls.length > 1 ? `<div class="thumbnail-bar">${thumbnails}</div>` : ''}
          <p><strong>Kategorie:</strong> ${listing.category}</p>
          <p><strong>Preis pro Tag:</strong> ${listing.price_per_day} €</p>
          <p><strong>Beschreibung:</strong><br>${listing.description}</p>

          <div class="chat-link">
            <button onclick="goToChat()">Nachricht an Vermieter senden</button>
          </div>

          <div class="calendar">
            <label><strong>Verfügbarkeit:</strong></label><br>
            <input type="text" id="date-range" readonly />
          </div>

          <div class="booking-form">
            <button onclick="requestBooking()">Mietanfrage senden</button>
          </div>
        </div>
        <div class="right">
          <div class="vermieter-box">
            <h3>Vermieter</h3>
            ${vermieterHTML}
          </div>
        </div>
      </div>
    `;

    setupFlatpickr();
  }

  function switchImage(imgElement) {
    const newSrc = imgElement.getAttribute("src");
    document.getElementById("mainImage").setAttribute("src", newSrc);
    document.querySelectorAll(".thumbnail-bar img").forEach(img => img.classList.remove("active"));
    imgElement.classList.add("active");
  }

  async function loadVermieterInfo(userId) {
    const { data: profile, error } = await supabase
      .from('profiles')
      .select('name, phone, city, bio')
      .eq('id', userId)
      .single();

    if (error || !profile) {
      return '<p>Keine Vermieterinformationen verfügbar.</p>';
    }

    return `
      <p><strong>Name:</strong> ${profile.name || 'Unbekannt'}</p>
      <p><strong>Telefon:</strong> ${profile.phone || 'Unbekannt'}</p>
      <p><strong>Wohnort:</strong> ${profile.city || 'Unbekannt'}</p>
      <p><strong>Über mich:</strong> ${profile.bio || 'Unbekannt'}</p>
    `;
  }

  async function loadUnavailableDates() {
    const { data, error } = await supabase
      .from('rentals')
      .select('start_date, end_date')
      .eq('listing_id', listingId);

    if (!error && data) {
      unavailableRanges = data.map(r => ({
        from: r.start_date,
        to: r.end_date
      }));
    }
  }

  function setupFlatpickr() {
    flatpickr("#date-range", {
      mode: "range",
      minDate: "today",
      dateFormat: "Y-m-d",
      disable: unavailableRanges
    });
  }

  async function requestBooking() {
    const input = document.getElementById('date-range').value;
    const dates = input.split(" to ");
    if (dates.length !== 2) return alert("Bitte Zeitraum auswählen.");

    const [start, end] = dates;

    const { error } = await supabase.from('rentals').insert({
      user_id: currentUser.id,
      listing_id: listingId,
      start_date: start,
      end_date: end,
      status: "offen",
      title: "Mietanfrage"
    });

    if (error) {
      alert("Fehler: " + error.message);
    } else {
      alert("Anfrage gesendet!");
      document.getElementById("date-range").value = "";
      await loadUnavailableDates();
      setupFlatpickr();
    }
  }

  function goToChat() {
    if (!currentUser || !listingOwnerId) return;
    if (currentUser.id === listingOwnerId) {
      alert("Du kannst dir selbst keine Nachricht schicken.");
      return;
    }
    window.location.href = `nachrichten.html?listing_id=${listingId}&with=${listingOwnerId}`;
  }

  loadListing();
</script>
</body>
</html>
