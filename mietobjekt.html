<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mietobjekt – Locorent</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root {
      --primary: #2e7d32;
      --secondary: #1b5e20;
      --bg: #f1f8e9;
      --white: #fff;
      --grey: #f7f7f7;
      --dark: #333;
      --radius: 10px;
      --shadow: rgba(0,0,0,0.1);
    }
    * { box-sizing: border-box; margin:0; padding:0; }
    body {
      font-family:'Poppins',sans-serif;
      background:var(--bg);
      color:var(--dark);
      line-height:1.6;
    }
    header {
      background:var(--primary);
      color:var(--white);
      padding:1rem 2rem;
      display:flex;
      justify-content:space-between;
      align-items:center;
    }
    header a {
      color:var(--white);
      margin-left:1rem;
      text-decoration:none;
      font-weight:600;
    }
    main {
      max-width:1000px;
      margin:2rem auto;
      background:var(--white);
      border-radius:var(--radius);
      box-shadow:0 4px 12px var(--shadow);
      overflow:hidden;
    }
    .gallery {
      position:relative;
    }
    .gallery img.main {
      width:100%;
      height:400px;
      object-fit:cover;
    }
    .gallery .thumbs {
      display:flex;
      gap:0.5rem;
      overflow-x:auto;
      padding:0.5rem;
      background:var(--grey);
    }
    .gallery .thumbs img {
      width:100px;
      height:60px;
      object-fit:cover;
      border-radius:var(--radius);
      cursor:pointer;
      border:2px solid transparent;
      transition: border-color .3s;
    }
    .gallery .thumbs img.active {
      border-color: var(--primary);
    }
    .content {
      padding:2rem;
    }
    .content h2 {
      margin-bottom:1rem;
      font-size:1.8rem;
    }
    .content p {
      margin:0.5rem 0;
    }
    .grid-2 {
      display:grid;
      grid-template-columns:2fr 1fr;
      gap:2rem;
      margin-top:2rem;
    }
    .box {
      background:var(--grey);
      padding:1.5rem;
      border-radius:var(--radius);
      box-shadow:0 2px 8px var(--shadow);
    }
    .box h3 {
      margin-bottom:1rem;
      font-size:1.2rem;
    }
    .box label {
      font-weight:600;
    }
    .box .flatpickr-input {
      width:100%;
      margin-top:0.5rem;
      padding:0.6rem;
      border-radius:6px;
      border:1px solid #ccc;
    }
    button {
      background:var(--primary);
      color:var(--white);
      padding:0.8rem 1.6rem;
      border:none;
      border-radius:var(--radius);
      font-weight:600;
      cursor:pointer;
      transition:background .3s;
      margin-top:1rem;
    }
    button:hover { background: var(--secondary); }
    footer {
      text-align:center;
      padding:1.5rem 2rem;
      background:var(--primary);
      color:var(--white);
      margin-top:2rem;
    }
    @media (max-width:768px) {
      .grid-2 { grid-template-columns:1fr; }
      .gallery img.main { height:250px; }
    }
  </style>
</head>
<body>
  <header>
    <h1>Locorent</h1>
    <nav>
      <a href="index.html">Start</a>
      <a href="profil.html">Profil</a>
    </nav>
  </header>

  <main id="listing-details">
    Lade Daten...
  </main>

  <footer>
    © 2025 Locorent – Nachhaltig mieten statt kaufen.
  </footer>

  <script>
    const supabase = window.supabase.createClient(
      'https://flnjalgqtkqycsaymmbd.supabase.co',
      'PUBLIC_ANON_KEY'
    );
    const params = new URLSearchParams(location.search);
    const id = params.get('id');
    async function load() {
      const { data:{ user } } = await supabase.auth.getUser();
      if(!user) return alert('Bitte einloggen.'), location='login.html';
      const { data:listing } = await supabase.from('listings').select('*').eq('id',id).single();
      const { data:profile } = await supabase.from('profiles').select('*').eq('id',listing.user_id).single();
      // Bilder
      const imgs = listing.image_urls||[];
      document.getElementById('listing-details').innerHTML = `
      <div class="gallery">
        <img src="${imgs[0]||listing.image_url}" class="main" id="mainImg">
        ${imgs.length>1?`<div class="thumbs">${imgs.map((u,i)=>`<img src="${u}" class="${i===0?'active':''}" onclick="pick(${i})">`).join('')}</div>`:''}
      </div>
      <div class="content">
        <h2>${listing.title}</h2>
        <p><strong>Kategorie:</strong> ${listing.category}</p>
        <p><strong>Preis pro Tag:</strong> ${listing.price_per_day} €</p>
        <p>${listing.description}</p>
        <div class="grid-2">
          <div class="box">
            <h3>Verfügbarkeit wählen</h3>
            <label for="date-range">Zeitraum:</label>
            <input id="date-range" readonly class="flatpickr-input"/>
            <button onclick="book()">Mietanfrage senden</button>
          </div>
          <div class="box">
            <h3>Vermieter</h3>
            <p><strong>Name:</strong> ${profile.name||'–'}</p>
            <p><strong>Telefon:</strong> ${profile.phone||'–'}</p>
            <p><strong>Wohnort:</strong> ${profile.city||'–'}</p>
            <p><strong>Über mich:</strong> ${profile.bio||'–'}</p>
            <button onclick="msg()">Nachricht senden</button>
          </div>
        </div>
      </div>
      `;
      flatpickr('#date-range',{mode:'range',minDate:'today',disable:await getDisabled()});
    }
    function pick(i){
      const thumbs=document.querySelectorAll('.thumbs img');
      thumbs.forEach(t=>t.classList.remove('active'));
      thumbs[i].classList.add('active');
      document.getElementById('mainImg').src = thumbs[i].src;
    }
    async function getDisabled(){
      const { data } = await supabase.from('rentals').select('start_date,end_date').eq('listing_id',id);
      return data.map(r=>({from:r.start_date,to:r.end_date}));
    }
    async function book(){
      const val=document.getElementById('date-range').value.split(' to ');
      if(val.length!==2) return alert('Zeitraum wählen');
      await supabase.from('rentals').insert({listing_id:id,user_id:(await supabase.auth.getUser()).data.user.id,start_date:val[0],end_date:val[1],status:'offen'});
      alert('Anfrage gesendet!');
    }
    function msg(){
      location=`nachrichten.html?listing_id=${id}&with=${listing.user_id}`;
    }
    load();
  </script>
</body>
</html>
