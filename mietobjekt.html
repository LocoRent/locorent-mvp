<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mietobjekt ‚Äì Locorent</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root {
      --primary: #2e7d32;
      --highlight: #a5d6a7;
      --radius: 18px;
      --shadow-light: rgba(46, 125, 50, 0.08);
      --font-primary: 'Poppins', sans-serif;
    }
    *, *::before, *::after { box-sizing: border-box; }
    html, body { margin:0; padding:0; font-family:var(--font-primary); background:#f1f8e9; min-height:100vh; display:flex; flex-direction:column;}
    header { background:var(--primary); color:#fff; padding:1rem 2rem; display:flex; justify-content:space-between; align-items:center; position:sticky; top:0; z-index:1000;}
    header h1 { cursor:pointer; margin:0;}
    #nav-toggle { display:none; background:none; border:none; color:#fff; font-size:1.5rem; cursor:pointer; }
    nav#nav-links { display:flex; gap:1rem; }
    nav#nav-links a { color:#fff; text-decoration:none; font-weight:600; }
    main { max-width:1080px; margin:2rem auto; background:#fff; padding:1rem; border-radius:var(--radius); box-shadow:0 12px 30px var(--shadow-light);}
    .listing-container { display:grid; grid-template-columns:1fr 1fr; gap:2rem; align-items:start;}
    .gallery img { width:100%; border-radius:var(--radius); }
    .thumbnails { display:flex; gap:0.5rem; margin-top:0.5rem; overflow-x:auto;}
    .thumbnails img { width:80px; height:60px; object-fit:cover; cursor:pointer; border:2px solid transparent; border-radius:8px; transition: all 0.3s ease;}
    .thumbnails img.active { border-color:var(--primary); transform:scale(1.1);}
    .vendor-info { margin-top:2rem; padding:1rem; border-radius:var(--radius); background:#f1f8e9;}
    button { font-weight:700; cursor:pointer; }
    @media(max-width:900px){ .listing-container { grid-template-columns:1fr; } .thumbnails img { width:60px; height:45px; } }
    @media(max-width:720px){ #nav-toggle { display:block; } nav#nav-links { display:none; flex-direction:column; gap:0.5rem; } nav#nav-links.show { display:flex; } }
  </style>
</head>
<body>
<header>
  <h1 onclick="location.href='index.html'">Locorent</h1>
  <button id="nav-toggle">‚ò∞</button>
  <nav id="nav-links"></nav>
</header>

<main id="listing-details" aria-live="polite" aria-busy="true">
  <div class="listing-container">

    <!-- Galerie -->
    <div class="gallery">
      <div class="main-image-wrapper">
        <img id="mainImage" src="https://via.placeholder.com/600x400?text=Kein+Bild" alt="Bild des Mietobjekts">
      </div>
      <div class="thumbnails"></div>
    </div>

    <!-- Details -->
    <div class="content">
      <h2 class="title">Titel des Mietobjekts</h2>
      <div class="info" style="display:flex; flex-wrap:wrap; gap:1rem; margin-bottom:1rem;">
        <span class="category" style="background:var(--highlight); padding:0.5rem 1rem; border-radius:12px;">Kategorie</span>
        <span class="price" style="background:var(--highlight); padding:0.5rem 1rem; border-radius:12px;">Preis/Tag</span>
        <span class="location" style="background:var(--highlight); padding:0.5rem 1rem; border-radius:12px;">Ort</span>
        <span class="created" style="background:var(--highlight); padding:0.5rem 1rem; border-radius:12px;">Online seit</span>
      </div>

      <div class="description-box" style="background:#f1f8e9; padding:1rem; border-radius:18px;">
        <h3>Beschreibung</h3>
        <p class="description">Hier steht die Beschreibung des Mietobjekts.</p>
      </div>

      <div class="buttons" style="display:flex; gap:1rem; flex-wrap:wrap; margin-top:1rem;">
        <button id="chatButton" style="flex:1;">Nachricht an Vermieter</button>
        <button id="add-to-favorites" style="flex:1;">‚≠ê Zu Favoriten hinzuf√ºgen</button>
      </div>

      <div class="vendor-info">
        <h3>Vermieter</h3>
        <p><strong>Name:</strong> <a href="#" class="vendor-name">Max Mustermann</a></p>
        <p class="vendor-location"><strong>Ort:</strong> Berlin</p>
        <p class="vendor-bio"><strong>√úber mich:</strong> Ich vermiete gerne mein Equipment.</p>
      </div>

    </div>
  </div>
</main>

<script>
  const supabase = window.supabase.createClient(
    'https://flnjalgqtkqycsaymmbd.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZsbmphbGdxdGtxeWNzYXltbWJkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg4NTkwOTAsImV4cCI6MjA2NDQzNTA5MH0.pPDeWCrjDrOGeHVJy5YmMQFYUGl7nvAyx3uxhQYNH_Q'
  );

  let currentUser = null;
  let listingOwnerId = null;

  async function updateNav() {
    const { data: { session } } = await supabase.auth.getSession();
    const nav = document.getElementById('nav-links');
    currentUser = session?.user || null;
    if(currentUser){
      nav.innerHTML = `<a href="index.html">Start</a><a href="profil.html">Profil</a><a href="nachrichten-inbox.html">Nachrichten</a><a href="favoriten.html">Favoriten</a><a href="inserate.html">Inserate</a><a href="#" onclick="logout()">Logout</a>`;
    } else {
      nav.innerHTML = `<a href="login.html">Einloggen</a><a href="register.html">Registrieren</a>`;
    }
  }

  async function logout() {
    await supabase.auth.signOut();
    location.href='login.html';
  }

  function capitalize(str){ return str ? str.charAt(0).toUpperCase()+str.slice(1) : ''; }
  function formatDate(dateStr){ return dateStr ? new Date(dateStr).toLocaleDateString('de-DE', {year:'numeric', month:'long', day:'numeric'}) : 'Unbekannt'; }

  async function loadListing(){
    const params = new URLSearchParams(location.search);
    const listingId = params.get('id');
    if(!listingId) return;

    const { data: listing } = await supabase.from('listings').select('*').eq('id',listingId).single();
    if(!listing) return alert('Inserat nicht gefunden');
    listingOwnerId = listing.user_id;

    const { data: profile } = await supabase.from('profiles').select('*').eq('id',listing.user_id).single();

    // Inhalte f√ºllen
    document.querySelector('.title').textContent = listing.title;
    document.querySelector('.category').textContent = 'üö≤ Kategorie: '+capitalize(listing.category);
    document.querySelector('.price').textContent = 'üí∞ Preis/Tag: '+listing.price_per_day+' ‚Ç¨';
    document.querySelector('.location').textContent = 'üìç Ort: '+(listing.location||'‚Äì');
    document.querySelector('.created').textContent = 'üïí Online seit: '+formatDate(listing.created_at);
    document.querySelector('.description').textContent = listing.description || 'Keine Beschreibung vorhanden.';

    document.querySelector('.vendor-name').textContent = profile?.name || '‚Äì';
    document.querySelector('.vendor-name').href = 'vermieter-profil.html?id='+listing.user_id;
    document.querySelector('.vendor-location').textContent = 'Ort: '+(profile?.city||'‚Äì');
    document.querySelector('.vendor-bio').textContent = '√úber mich: '+(profile?.bio||'‚Äì');

    const images = listing.image_urls || (listing.image_url ? [listing.image_url] : []);
    const mainImage = document.getElementById('mainImage');
    mainImage.src = images[0] || 'https://via.placeholder.com/600x400?text=Kein+Bild';

    const thumbsContainer = document.querySelector('.thumbnails');
    thumbsContainer.innerHTML = images.map((url,i)=>`
      <img src="${url}" class="${i===0?'active':''}" alt="Vorschaubild ${i+1}" tabindex="0"
        onclick="switchImage('${url}',this)" onkeydown="if(event.key==='Enter'||event.key===' '){switchImage('${url}',this);}">`).join('');

  }

  function switchImage(url, thumb){
    document.getElementById('mainImage').src=url;
    document.querySelectorAll('.thumbnails img').forEach(img=>img.classList.remove('active'));
    thumb.classList.add('active');
  }

  document.getElementById('chatButton').addEventListener('click', ()=>{
    if(!currentUser) return alert("Bitte einloggen, um Nachrichten zu senden.");
    const params = new URLSearchParams(location.search);
    window.location.href = `nachrichten.html?listing_id=${params.get('id')}&with=${listingOwnerId}`;
  });

  document.getElementById('nav-toggle').addEventListener('click', ()=>{
    const nav = document.getElementById('nav-links');
    nav.classList.toggle('show');
  });

  updateNav();
  loadListing();
</script>
</body>
</html>
