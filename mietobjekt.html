<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mietobjekt – Locorent</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    /* Dein CSS hier, bleibt unverändert */
  </style>
</head>
<body>
<header>
  <h1>Locorent</h1>
  <nav>
    <a href="index.html">Start</a>
    <a href="profil.html">Profil</a>
  </nav>
</header>

<main>
  <div id="listing-details">Lade Daten...</div>
</main>

<script>
  const supabase = window.supabase.createClient(
    'https://flnjalgqtkqycsaymmbd.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZsbmphbGdxdGtxeWNzYXltbWJkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg4NTkwOTAsImV4cCI6MjA2NDQzNTA5MH0.pPDeWCrjDrOGeHVJy5YmMQFYUGl7nvAyx3uxhQYNH_Q'
  );

  const params = new URLSearchParams(window.location.search);
  const listingId = params.get('id');
  let currentUser = null;
  let listingOwnerId = null;

  async function loadListing() {
    const { data: { user } } = await supabase.auth.getUser();
    if (!user) {
      alert("Bitte einloggen.");
      return;
    }
    currentUser = user;

    const { data: listing, error } = await supabase
      .from('listings')
      .select('*')
      .eq('id', listingId)
      .single();

    const container = document.getElementById('listing-details');
    if (error || !listing) {
      container.innerHTML = '<p>Fehler beim Laden des Inserats.</p>';
      return;
    }

    listingOwnerId = listing.user_id;
    await loadVermieterInfo(listingOwnerId);

    const imageUrls = listing.image_urls || [];
    const mainImage = imageUrls[0] || 'https://via.placeholder.com/800x300?text=Kein+Bild';
    const thumbnails = imageUrls.map((url, idx) =>
      `<img src="${url}" class="${idx === 0 ? 'active' : ''}" onclick="switchImage(this)">`
    ).join('');

    container.innerHTML = `
      <div class="container">
        <div class="left">
          <h2>${listing.title}</h2>
          <img src="${mainImage}" alt="Hauptbild" class="main-image" id="mainImage">
          ${imageUrls.length > 1 ? `<div class="thumbnail-bar">${thumbnails}</div>` : ''}
          <p><strong>Kategorie:</strong> ${listing.category}</p>
          <p><strong>Preis pro Tag:</strong> ${listing.price_per_day} €</p>
          <p><strong>Beschreibung:</strong><br>${listing.description}</p>
        </div>
        <div class="right">
          <div class="vermieter-box">
            <h3>Vermieter</h3>
            <p><strong>Name:</strong> <span id="vermieter-name">Lade Name...</span></p>
            <p><strong>Telefon:</strong> <span id="vermieter-phone">Lade Telefonnummer...</span></p>
            <p><strong>Wohnort:</strong> <span id="vermieter-city">Lade Wohnort...</span></p>
            <p><strong>Über mich:</strong> <span id="vermieter-bio">Lade Bio...</span></p>
          </div>
        </div>
      </div>
    `;

    setupFlatpickr();
  }

  function switchImage(imgElement) {
    const newSrc = imgElement.getAttribute("src");
    document.getElementById("mainImage").setAttribute("src", newSrc);
    document.querySelectorAll(".thumbnail-bar img").forEach(img => img.classList.remove("active"));
    imgElement.classList.add("active");
  }

  async function loadVermieterInfo(userId) {
    const { data: profile, error } = await supabase
      .from('profiles')
      .select('name, phone, city, bio')
      .eq('id', userId)
      .single();

    if (error || !profile) {
      console.error("Fehler beim Laden der Vermieterinformationen:", error);
      document.getElementById('vermieter-name').textContent = 'Unbekannt';
      document.getElementById('vermieter-phone').textContent = 'Unbekannt';
      document.getElementById('vermieter-city').textContent = 'Unbekannt';
      document.getElementById('vermieter-bio').textContent = 'Unbekannt';
      return;
    }

    document.getElementById('vermieter-name').textContent = profile.name || 'Unbekannt';
    document.getElementById('vermieter-phone').textContent = profile.phone || 'Unbekannt';
    document.getElementById('vermieter-city').textContent = profile.city || 'Unbekannt';
    document.getElementById('vermieter-bio').textContent = profile.bio || 'Unbekannt';
  }

  function setupFlatpickr() {
    flatpickr("#date-range", {
      mode: "range",
      minDate: "today",
      dateFormat: "Y-m-d"
    });
  }

  loadListing();
</script>
</body>
</html>
