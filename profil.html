<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mein Profil ‚Äì Locorent</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root {
      --primary-color: #2e7d32;
      --primary-dark: #1b5e20;
      --background-color: #f1f8e9;
      --white: #fff;
      --light-gray: #f5f5f5;
      --border-radius: 12px;
      --shadow-color: rgba(0, 0, 0, 0.1);
      --max-width: 600px;
    }
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: 'Poppins', sans-serif;
      background-color: var(--background-color);
      color: #333;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    header {
      background-color: var(--primary-color);
      color: var(--white);
      width: 100%;
      padding: 1.5rem 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 1000;
      box-shadow: 0 2px 8px var(--shadow-color);
      user-select: none;
    }
    header h1 {
      font-weight: 600;
      font-size: 1.8rem;
      cursor: pointer;
    }
    nav#nav-links a {
      color: var(--white);
      margin-left: 1.5rem;
      text-decoration: none;
      font-weight: 600;
      transition: border-bottom 0.3s ease;
    }
    nav#nav-links a:hover,
    nav#nav-links a:focus {
      border-bottom: 2px solid var(--primary-dark);
      outline: none;
    }
    main.container {
      max-width: var(--max-width);
      background: var(--white);
      border-radius: var(--border-radius);
      box-shadow: 0 6px 18px var(--shadow-color);
      padding: 2rem 2.5rem;
      margin: 3rem 1rem 4rem;
      width: 100%;
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    h2 {
      color: var(--primary-color);
      font-weight: 700;
      margin-bottom: 1rem;
      user-select: none;
    }
    label {
      display: block;
      margin-top: 1rem;
      font-weight: 600;
      user-select: none;
    }
    input, textarea {
      width: 100%;
      padding: 0.7rem;
      margin-top: 0.3rem;
      border: 1px solid #ccc;
      border-radius: var(--border-radius);
      font-size: 1rem;
      font-family: 'Poppins', sans-serif;
      transition: border-color 0.3s ease;
    }
    input:focus, textarea:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 5px var(--primary-color);
    }
    button {
      margin-top: 1.5rem;
      padding: 0.9rem 1.5rem;
      background-color: var(--primary-color);
      color: var(--white);
      border: none;
      border-radius: var(--border-radius);
      font-weight: 700;
      font-size: 1.1rem;
      cursor: pointer;
      user-select: none;
      transition: background-color 0.3s ease, box-shadow 0.3s ease;
    }
    button:hover, button:focus-visible {
      background-color: var(--primary-dark);
      box-shadow: 0 0 12px var(--primary-dark);
      outline: none;
    }
    button.delete {
      background-color: #b00020;
      margin-top: 2rem;
    }
    button.delete:hover, button.delete:focus-visible {
      background-color: #7a0013;
      box-shadow: 0 0 12px #7a0013;
    }
    footer {
      width: 100%;
      background-color: var(--primary-color);
      color: var(--white);
      padding: 2rem 0;
      box-shadow: 0 -2px 12px var(--shadow-color);
      user-select: none;
      text-align: center;
      font-size: 0.9rem;
    }
    @media (max-width: 600px) {
      main.container {
        padding: 1.5rem 1.5rem;
        margin: 2rem 1rem 3rem;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1 tabindex="0" role="banner" aria-label="Locorent Startseite" onclick="location.href='index.html'">Locorent</h1>
    <nav id="nav-links" role="navigation" aria-label="Hauptnavigation"></nav>
  </header>

  <main class="container" role="main" aria-label="Mein Profil">
    <h2>Mein Profil</h2>
    <label for="name">Name</label>
    <input type="text" id="name" placeholder="Dein Name" autocomplete="name" />

    <label for="email">E-Mail</label>
    <input type="email" id="email" disabled autocomplete="email" />

    <label for="phone">Telefon</label>
    <input type="text" id="phone" placeholder="Telefonnummer" autocomplete="tel" />

    <label for="city">Wohnort</label>
    <input type="text" id="city" placeholder="Wohnort" autocomplete="address-level2" />

    <label for="bio">√úber mich</label>
    <textarea id="bio" rows="4" placeholder="Erz√§hle etwas √ºber dich..."></textarea>

    <button id="save-btn" onclick="saveProfile()">Profil speichern</button>

    <label for="password">Neues Passwort</label>
    <input type="password" id="password" placeholder="Neues Passwort eingeben" autocomplete="new-password" />
    <button id="change-pw-btn" onclick="changePassword()">Passwort √§ndern</button>

    <button id="delete-profile-btn" class="delete" onclick="deleteProfile()" aria-label="Profil dauerhaft l√∂schen">Profil l√∂schen</button>
  </main>

  <footer role="contentinfo">
    ¬© 2025 Locorent ‚Äì Mieten statt kaufen. Gemeinsam nachhaltig.
  </footer>

  <script>
    const supabase = window.supabase.createClient(
      'https://flnjalgqtkqycsaymmbd.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZsbmphbGdxdGtxeWNzYXltbWJkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg4NTkwOTAsImV4cCI6MjA2NDQzNTA5MH0.pPDeWCrjDrOGeHVJy5YmMQFYUGl7nvAyx3uxhQYNH_Q'
    );

    async function updateNav() {
      const { data: { session } } = await supabase.auth.getSession();
      const nav = document.getElementById('nav-links');

      if (session?.user) {
        nav.innerHTML = `
          <a href="index.html">Start</a>
          <a href="profil.html" aria-current="page">Mein Profil</a>
          <a href="nachrichten-inbox.html">üì® Nachrichten</a>
          <a href="favoriten.html">Meine Favoriten</a>
          <a href="inserate.html">Meine Inserate</a>
          <a href="javascript:void(0);" onclick="logout()">Logout</a>
        `;
      } else {
        nav.innerHTML = `
          <a href="login.html">Einloggen</a>
          <a href="register.html">Registrieren</a>
        `;
      }
    }

    async function logout() {
      await supabase.auth.signOut();
      window.location.href = "login.html";
    }

    async function loadProfile() {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session?.user) {
        window.location.href = "login.html";
        return;
      }
      const user = session.user;
      document.getElementById('email').value = user.email;

      const { data, error } = await supabase.from('profiles').select('*').eq('id', user.id).single();
      if (error) {
        alert("Fehler beim Laden des Profils.");
        return;
      }
      if (data) {
        document.getElementById('name').value = data.name || '';
        document.getElementById('phone').value = data.phone || '';
        document.getElementById('city').value = data.city || '';
        document.getElementById('bio').value = data.bio || '';
      }
    }

    async function saveProfile() {
      const { data: { user } } = await supabase.auth.getSession();
      if (!user) {
        alert("Nicht eingeloggt!");
        return;
      }
      const updates = {
        id: user.id,
        name: document.getElementById('name').value.trim(),
        phone: document.getElementById('phone').value.trim(),
        city: document.getElementById('city').value.trim(),
        bio: document.getElementById('bio').value.trim()
      };
      const { error } = await supabase.from('profiles').upsert(updates);
      if (error) {
        alert("Fehler beim Speichern: " + error.message);
      } else {
        alert("Profil gespeichert!");
      }
    }

    async function changePassword() {
      const password = document.getElementById('password').value.trim();
      if (!password) return alert("Bitte ein Passwort eingeben.");
      const { data, error } = await supabase.auth.updateUser({ password });
      if (error) {
        alert("Fehler beim √Ñndern des Passworts: " + error.message);
      } else {
        alert("Passwort erfolgreich ge√§ndert.");
        document.getElementById('password').value = '';
      }
    }

    async function deleteProfile() {
      if (!confirm("Willst du dein Profil wirklich dauerhaft l√∂schen? Alle Inserate, Nachrichten und Daten gehen verloren!")) return;

      const { data: { session } } = await supabase.auth.getSession();
      if (!session?.user) {
        alert("Nicht eingeloggt.");
        window.location.href = "login.html";
        return;
      }
      const userId = session.user.id;

      try {
        // Alle Inserate l√∂schen
        let { error: delListingsError } = await supabase.from('listings').delete().eq('user_id', userId);
        if (delListingsError) throw delListingsError;

        // Alle Nachrichten l√∂schen (angenommen Tabelle hei√üt 'messages' mit Spalte sender_id oder recipient_id)
        let { error: delMessagesError } = await supabase
          .from('messages')
          .delete()
          .or(`sender_id.eq.${userId},recipient_id.eq.${userId}`);
        if (delMessagesError) throw delMessagesError;

        // Alle Favoriten l√∂schen
        let { error: delFavError } = await supabase.from('favorites').delete().eq('user_id', userId);
        if (delFavError) throw delFavError;

        // Alle Bewertungen gesendet UND empfangen l√∂schen (optional)
        let { error: delReviewsError } = await supabase
          .from('reviews')
          .delete()
          .or(`from_user_id.eq.${userId},to_user_id.eq.${userId}`);
        if (delReviewsError) throw delReviewsError;

        // Profil l√∂schen
        let { error: delProfileError } = await supabase.from('profiles').delete().eq('id', userId);
        if (delProfileError) throw delProfileError;

        // Userkonto l√∂schen
        const { error: delUserError } = await supabase.auth.admin.deleteUser(userId);
        if (delUserError) throw delUserError;

        alert("Profil und alle zugeh√∂rigen Daten wurden gel√∂scht.");
        window.location.href = "index.html";

      } catch (error) {
        alert("Fehler beim L√∂schen: " + error.message);
      }
    }

    updateNav();
    loadProfile();
  </script>
</body>
</html>
