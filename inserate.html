<!-- ... HEAD bleibt gleich ... -->
<body>
  <header>
    <h1>Locorent</h1>
    <nav>
      <a href="index.html">Start</a>
      <a href="profil.html">Profil</a>
      <a href="#" id="logoutBtn">Logout</a>
    </nav>
  </header>

  <main>
    <h2>Meine Inserate</h2>
    <div id="myListings" class="grid">Lade deine Inserate...</div>

    <div class="form">
      <h3 id="form-title">Neues Inserat erstellen</h3>
      <input type="hidden" id="editing-id" />

      <label for="title">Titel</label>
      <input type="text" id="title" />

      <label for="description">Beschreibung</label>
      <textarea id="description" rows="3"></textarea>

      <label for="price">Preis pro Tag (€)</label>
      <input type="number" id="price" />

      <label for="category">Kategorie</label>
      <select id="category">
        <option value="">Bitte wählen</option>
        <option value="Fahrzeuge">Fahrzeuge</option>
        <option value="Werkzeuge">Werkzeuge</option>
        <option value="Technik">Technik</option>
        <option value="Haushalt">Haushalt</option>
        <option value="Garten">Garten</option>
      </select>

      <label for="image">Bild hochladen (optional)</label>
      <input type="file" id="image" accept="image/*" />

      <button onclick="saveListing()">Inserat speichern</button>
    </div>
  </main>

  <script>
    const supabase = window.supabase.createClient(
      'https://flnjalgqtkqycsaymmbd.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...'
    );

    document.getElementById('logoutBtn').onclick = async () => {
      await supabase.auth.signOut();
      window.location.href = 'login.html';
    };

    async function saveListing() {
      const title = document.getElementById('title').value.trim();
      const description = document.getElementById('description').value.trim();
      const price = parseFloat(document.getElementById('price').value);
      const category = document.getElementById('category').value;
      const imageFile = document.getElementById('image').files[0];
      const editingId = document.getElementById('editing-id').value;

      const { data: { user } } = await supabase.auth.getUser();
      if (!user) return alert("Nicht eingeloggt.");

      let image_url = null;

      if (imageFile) {
        const fileName = `${user.id}_${Date.now()}_${imageFile.name}`;
        const { error: uploadError } = await supabase.storage
          .from('listing-images')
          .upload(fileName, imageFile);
        if (uploadError) return alert("Bild-Upload fehlgeschlagen: " + uploadError.message);

        const { data: { publicUrl } } = supabase.storage
          .from('listing-images')
          .getPublicUrl(fileName);
        image_url = publicUrl;
      }

      const payload = {
        title,
        description,
        price_per_day: price,
        category,
        ...(image_url && { image_url })
      };

      if (editingId) {
        const { error } = await supabase
          .from('listings')
          .update(payload)
          .eq('id', editingId);

        if (error) return alert("Fehler beim Aktualisieren: " + error.message);
        alert("Inserat aktualisiert!");
        document.getElementById("form-title").textContent = "Neues Inserat erstellen";
      } else {
        const { error } = await supabase.from('listings').insert({
          ...payload,
          user_id: user.id
        });

        if (error) return alert("Fehler beim Speichern: " + error.message);
        alert("Inserat gespeichert!");
      }

      document.getElementById('editing-id').value = '';
      document.getElementById('title').value = '';
      document.getElementById('description').value = '';
      document.getElementById('price').value = '';
      document.getElementById('category').value = '';
      document.getElementById('image').value = '';

      loadMyListings();
    }

    async function deleteListing(id) {
      if (!confirm("Möchtest du dieses Inserat wirklich löschen?")) return;
      const { error } = await supabase.from('listings').delete().eq('id', id);
      if (error) alert("Fehler beim Löschen: " + error.message);
      else loadMyListings();
    }

    function editListing(item) {
      document.getElementById('editing-id').value = item.id;
      document.getElementById('title').value = item.title;
      document.getElementById('description').value = item.description;
      document.getElementById('price').value = item.price_per_day;
      document.getElementById('category').value = item.category;
      document.getElementById("form-title").textContent = "Inserat bearbeiten";
      window.scrollTo({ top: document.body.scrollHeight, behavior: "smooth" });
    }

    async function loadMyListings() {
      const { data: { user } } = await supabase.auth.getUser();
      const { data, error } = await supabase
        .from('listings')
        .select('*')
        .eq('user_id', user.id)
        .order('created_at', { ascending: false });

      const container = document.getElementById('myListings');
      container.innerHTML = '';

      if (error || !data || data.length === 0) {
        container.innerHTML = "<p>Keine Inserate gefunden.</p>";
        return;
      }

      data.forEach(item => {
        const div = document.createElement('div');
        div.className = 'card';
        div.innerHTML = `
          <button class="delete-btn" onclick="deleteListing('${item.id}')">Löschen</button>
          <img src="${item.image_url}" alt="${item.title}" />
          <h4>${item.title}</h4>
          <p><strong>Kategorie:</strong> ${item.category}</p>
          <p><strong>Preis:</strong> ${item.price_per_day} €</p>
          <p>${item.description || ''}</p>
          <button onclick='editListing(${JSON.stringify(item)})'>Bearbeiten</button>
        `;
        container.appendChild(div);
      });
    }

    loadMyListings();
  </script>
</body>
</html>
